<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üêµ BTD6 Social</title>
<style>
  body{font-family:"Segoe UI",Arial,sans-serif;background:#121212;color:#fff;margin:0}
  header{background:#2d2d2d;padding:10px 20px;text-align:center;font-size:1.4em;color:#f6b93b;font-weight:700}
  #navTabs{display:flex;justify-content:space-around;background:#1e1e1e;padding:10px 0}
  #navTabs button{background:none;border:none;color:#f6b93b;font-weight:700;cursor:pointer;font-size:1em}
  #navTabs button:hover{color:#fff}
  #contentArea{max-width:900px;margin:20px auto;background:#1a1a1a;border-radius:10px;padding:15px;box-shadow:0 0 10px rgba(0,0,0,.4)}
  .feedPost{background:#1e1e1e;border-radius:8px;padding:10px 15px;margin-bottom:15px;box-shadow:0 0 5px rgba(0,0,0,.3)}
  .feedPost img{max-width:100%;border-radius:8px;margin-top:8px}
  .small{color:#999;font-size:0.9em}
  button.action{background:#f6b93b;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;margin-right:6px;color:#000;font-weight:700}
  button.danger{background:#e74c3c;color:#fff}
  textarea,input[type=text],input[type=password]{width:100%;padding:8px;border-radius:6px;border:none;background:#101018;color:#fff;box-sizing:border-box}
  ul.simple{list-style:none;padding:0;margin:0}
  li.clickable{background:#171722;padding:8px;border-radius:6px;margin-bottom:6px;cursor:pointer}
  li.clickable.unread{font-weight:700;color:#ff5a5a}
  .row{display:flex;gap:8px}
  .col{flex:1}
  @media (max-width:880px){ #leftSidebar{display:none} #contentArea{max-width:95%;} }
</style>
</head>
<body>
<header>üêµ BTD6 Social</header>

<div id="navTabs" aria-hidden="false">
  <button onclick="switchTab('feed')">Feed</button>
  <button onclick="switchTab('threads')">Threads</button>
  <button onclick="switchTab('messages')">Messages</button>
  <button onclick="switchTab('profile')">Profile</button>
</div>

<div id="contentArea">Loading...</div>

<script>
/* ================= CONFIG ================= */
let SERVER_URL = "";
const KEY = "5duM4W8HZiQBSU4v";
const ROOM = "btd6-social";
let currentUser = JSON.parse(localStorage.getItem("btd6_profile") || "{}");
if (!currentUser.username) currentUser.username = "You";

/* ================= Utilities ================= */
const el = sel => document.querySelector(sel);
const qAll = sel => Array.from(document.querySelectorAll(sel));
const saveJSON = (k, v) => localStorage.setItem(k, JSON.stringify(v));
const loadJSON = (k, fallback) => { try { return JSON.parse(localStorage.getItem(k) || "null") || fallback } catch(e){ return fallback } };

/* ================= Load tunnel.txt (SERVER_URL) ================= */
async function loadConfig(){
  try {
    const res = await fetch("tunnel.txt");
    if (res.ok) {
      SERVER_URL = (await res.text()).trim();
      if (SERVER_URL.endsWith("/")) SERVER_URL = SERVER_URL.slice(0, -1);
      console.log("SERVER_URL =", SERVER_URL);
    }
  } catch(e) {
    console.warn("tunnel.txt not found or cannot be loaded.");
  }
}

/* ================= FEED (local + btd6-social.json) ================= */
let allFeedPosts = [];
let feedInterval = null;

async function loadFeed(){
  clearInterval(feedInterval);
  await refreshFeed();            // load now
  feedInterval = setInterval(refreshFeed, 30000); // auto-refresh every 30s
}

async function refreshFeed(){
  const area = el("#contentArea");
  area.innerHTML = "<div class='feedPost'><div class='small'>Loading feed...</div></div>";
  // load server JSON (static file)
  let serverPosts = [];
  try {
    const res = await fetch("btd6-social.json");
    if (res.ok) {
      const json = await res.json();
      serverPosts = json.posts || [];
    }
  } catch(e){ console.warn("Could not load btd6-social.json", e); }

  // load local posts
  const localPosts = loadJSON("btd6_localPosts", []);
  // merge local first
  allFeedPosts = [...localPosts, ...serverPosts];

  renderFeed();
}

function renderFeed(){
  const area = el("#contentArea");
  area.innerHTML = "";

  // Create box
  const box = document.createElement("div"); box.className = "feedPost";
  box.innerHTML = `
    <h3>Create a Post</h3>
    <textarea id="newPostText" placeholder="What's on your mind?" style="height:70px"></textarea>
    <input id="newPostLink" placeholder="Optional link" style="margin-top:8px">
    <input type="file" id="newPostImage" accept="image/*" style="margin-top:8px">
    <div style="margin-top:8px"><button class="action" onclick="handleCreatePost()">Post</button></div>
  `;
  area.appendChild(box);

  // Posts (newest first)
  allFeedPosts.sort((a,b)=>b.id - a.id);
  for (const p of allFeedPosts){
    const postEl = document.createElement("div"); postEl.className = "feedPost";
    let html = `<h4><a href="#" onclick="openProfile('${escapeHtml(p.author)}');return false">@${escapeHtml(p.author)}</a></h4>`;
    if (p.text) html += `<p>${escapeHtml(p.text)}</p>`;
    html += `<div class="small">${escapeHtml(p.time || "")}</div>`;
    // image (show if present)
    postEl.innerHTML = html;
    if (p.image) {
      // If image is a data URL or remote link, attempt to show directly.
      const img = document.createElement("img");
      img.src = p.image;
      img.alt = "";
      img.onload = ()=>{}; img.onerror = ()=>{ /* silently ignore */ };
      postEl.appendChild(img);
    }
    if (p.link) {
      const linkEl = document.createElement("div");
      linkEl.innerHTML = `<p><a href="${escapeAttr(p.link)}" target="_blank">${escapeHtml(p.link)}</a></p>`;
      postEl.appendChild(linkEl);
    }

    // action bar
    const likeCount = (p.likes||[]).length;
    const dislikeCount = (p.dislikes||[]).length;
    const commentCount = (p.comments||[]).length;
    const actions = document.createElement("div");
    actions.style.marginTop = "8px";
    actions.innerHTML = `
      <button class="action" onclick="toggleLike(${p.id},'like')">üëç ${likeCount}</button>
      <button class="action" onclick="toggleLike(${p.id},'dislike')">üëé ${dislikeCount}</button>
      <button class="action" onclick="promptComment(${p.id})">üí¨ ${commentCount}</button>
      <button class="action" onclick="sharePost(${p.id})">üîó Share</button>
    `;
    if (p.author === (currentUser.username || "You")) {
      const delBtn = document.createElement("button");
      delBtn.className = "danger";
      delBtn.textContent = "üóë Delete";
      delBtn.onclick = ()=> deletePost(p.id);
      actions.appendChild(delBtn);
    }
    postEl.appendChild(actions);

    // comments
    const commentsWrap = document.createElement("div");
    commentsWrap.style.marginTop = "6px";
    commentsWrap.style.borderTop = "1px solid #333";
    commentsWrap.style.paddingTop = "6px";
    if (p.comments && p.comments.length) {
      p.comments.forEach(c=>{
        const cd = document.createElement("div");
        cd.style.marginLeft = "8px";
        cd.className = "small";
        cd.innerHTML = `<b>${escapeHtml(c.author)}</b>: ${escapeHtml(c.text)} <span class="small">(${escapeHtml(c.time||"")})</span>`;
        commentsWrap.appendChild(cd);
      });
    }
    postEl.appendChild(commentsWrap);

    area.appendChild(postEl);
  }
}

/* Handle create post (stores locally; if you want server upload implement server POST) */
async function handleCreatePost(){
  const text = document.getElementById("newPostText").value.trim();
  const link = document.getElementById("newPostLink").value.trim();
  const file = document.getElementById("newPostImage").files[0];
  if (!text && !link && !file) return alert("Write something or add media.");
  const newPost = { id: Date.now(), author: currentUser.username || "You", text, link, image: "", time: new Date().toLocaleString(), likes: [], dislikes: [], comments: [] };

  if (file) {
    // store as data URL to avoid broken images after restart
    const dataUrl = await fileToDataURL(file);
    newPost.image = dataUrl;
  }

  // save locally
  const local = loadJSON("btd6_localPosts", []);
  local.push(newPost);
  saveJSON("btd6_localPosts", local);

  // refresh feed immediately
  await refreshFeed();
  // clear inputs
  document.getElementById("newPostText").value = "";
  document.getElementById("newPostLink").value = "";
  document.getElementById("newPostImage").value = "";
}

function fileToDataURL(file){
  return new Promise((res, rej) => {
    const r = new FileReader();
    r.onload = () => res(r.result);
    r.onerror = e => rej(e);
    r.readAsDataURL(file);
  });
}

function toggleLike(id, type){
  const me = currentUser.username || "You";
  const p = allFeedPosts.find(x=>x.id === id);
  if (!p) return;
  p.likes = p.likes || []; p.dislikes = p.dislikes || [];
  if (type === "like") {
    if (p.likes.includes(me)) p.likes = p.likes.filter(u=>u!==me);
    else { p.likes.push(me); p.dislikes = p.dislikes.filter(u=>u!==me); }
  } else {
    if (p.dislikes.includes(me)) p.dislikes = p.dislikes.filter(u=>u!==me);
    else { p.dislikes.push(me); p.likes = p.likes.filter(u=>u!==me); }
  }
  // update local copy if present
  const local = loadJSON("btd6_localPosts", []);
  const idx = local.findIndex(x=>x.id===p.id);
  if (idx >= 0) { local[idx] = p; saveJSON("btd6_localPosts", local); }
  renderFeed();
}

function promptComment(id){
  const txt = prompt("Enter comment:");
  if (!txt) return;
  const p = allFeedPosts.find(x=>x.id === id);
  if (!p) return;
  p.comments = p.comments || [];
  p.comments.push({ author: currentUser.username || "You", text: txt, time: new Date().toLocaleTimeString() });
  // update local storage if applicable
  const local = loadJSON("btd6_localPosts", []);
  const idx = local.findIndex(x=>x.id===p.id);
  if (idx >= 0){ local[idx] = p; saveJSON("btd6_localPosts", local); }
  renderFeed();
}

function deletePost(id){
  if (!confirm("Delete this post?")) return;
  let local = loadJSON("btd6_localPosts", []);
  local = local.filter(p => p.id !== id);
  saveJSON("btd6_localPosts", local);
  allFeedPosts = allFeedPosts.filter(p => p.id !== id);
  renderFeed();
}

function sharePost(id){
  const url = window.location.origin + window.location.pathname + "?post=" + id;
  navigator.clipboard.writeText(url).then(()=> alert("Link copied!"), ()=> alert("Could not copy link."));
}

/* ================= THREADS (server-synced via /room/<ROOM>) ================= */
let threadInterval = null;

async function loadThreads(){
  clearInterval(threadInterval);
  await refreshThreads();
  threadInterval = setInterval(refreshThreads, 30000); // every 30s
}

async function refreshThreads(){
  const area = el("#contentArea");
  area.innerHTML = "<div class='feedPost'><div class='small'>Loading threads...</div></div>";
  if (!SERVER_URL) {
    area.innerHTML = "<div class='feedPost'><div class='small'>Server not configured (tunnel.txt missing).</div></div>";
    return;
  }
  try {
    const res = await fetch(`${SERVER_URL}/room/${ROOM}?key=${KEY}`);
    const json = await res.json();
    if (!json.ok) throw new Error("server responded not ok");
    const threads = json.data?.threads || [];
    renderThreads(threads);
  } catch (e) {
    console.warn("Could not load threads from server.", e);
    area.innerHTML = "<div class='feedPost'><div class='small'>‚ö†Ô∏è Could not reach server for threads.</div></div>";
  }
}

function renderThreads(threads){
  const area = el("#contentArea");
  area.innerHTML = `
    <div class="feedPost">
      <h3>Create a Thread</h3>
      <input id="threadTitle" placeholder="Thread title" style="margin-top:8px">
      <textarea id="threadBody" placeholder="Thread content" style="height:70px;margin-top:8px"></textarea>
      <div style="margin-top:8px"><button class="action" onclick="createThread()">Create</button></div>
    </div>
  `;
  threads.sort((a,b)=>b.id - a.id);
  threads.forEach(t=>{
    const d = document.createElement("div"); d.className = "feedPost";
    let inner = `<h4>${escapeHtml(t.title)}</h4><div class="small">by ${escapeHtml(t.author)}${t.time ? " ‚Ä¢ " + escapeHtml(t.time) : ""}</div>`;
    if (t.text) inner += `<p>${escapeHtml(t.text)}</p>`;
    inner += `<div style="margin-top:6px"><button class="action" onclick="replyThread(${t.id})">üí¨ ${ (t.replies||[]).length }</button></div>`;
    if (t.replies && t.replies.length){
      inner += `<div style="margin-top:8px;border-top:1px solid #333;padding-top:6px">`;
      t.replies.forEach(r=>{
        inner += `<div style="margin-left:8px" class="small"><b>${escapeHtml(r.author)}</b>: ${escapeHtml(r.text)}</div>`;
      });
      inner += `</div>`;
    }
    d.innerHTML = inner;
    area.appendChild(d);
  });
}

async function createThread(){
  const title = document.getElementById("threadTitle").value.trim();
  const text = document.getElementById("threadBody").value.trim();
  if (!title || !text) return alert("Enter title and text.");
  if (!SERVER_URL) return alert("Server not configured (tunnel.txt missing).");

  try {
    const res = await fetch(`${SERVER_URL}/room/${ROOM}?key=${KEY}`);
    const json = await res.json();
    const data = json.data || {};
    data.threads ||= [];
    data.threads.unshift({ id: Date.now(), author: currentUser.username || "You", title, text, replies: [], time: new Date().toLocaleString() });
    await fetch(`${SERVER_URL}/room/${ROOM}?key=${KEY}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });
    await refreshThreads();
  } catch (e) {
    alert("Could not create thread (server error).");
    console.error(e);
  }
}

async function replyThread(id){
  const txt = prompt("Reply:");
  if (!txt) return;
  if (!SERVER_URL) return alert("Server not configured (tunnel.txt missing).");
  try {
    const res = await fetch(`${SERVER_URL}/room/${ROOM}?key=${KEY}`);
    const json = await res.json();
    const data = json.data || {};
    data.threads ||= [];
    const thread = data.threads.find(t => t.id === id);
    if (!thread) return alert("Thread not found on server.");
    thread.replies ||= [];
    thread.replies.push({ author: currentUser.username || "You", text: txt, time: new Date().toLocaleTimeString() });
    await fetch(`${SERVER_URL}/room/${ROOM}?key=${KEY}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });
    await refreshThreads();
  } catch (e) {
    alert("Could not reply to thread (server error).");
    console.error(e);
  }
}

/* ================= DMs (local-only) ================= */
function loadDMList(){
  const area = el("#contentArea");
  const dms = loadJSON("btd6_localDMs", {});
  let html = `<div class="feedPost"><h3>Messages</h3>`;
  const users = Object.keys(dms).sort();
  if (users.length === 0) html += `<div class="small">No conversations yet.</div>`;
  for (const u of users){
    const unread = dms[u].some(m => !m.read) ? " üî¥" : "";
    html += `<div style="margin-bottom:6px"><a href="#" onclick="openDM('${u}');return false">@${escapeHtml(u)}</a>${unread}</div>`;
  }
  html += `<div style="margin-top:8px"><input id="newDMUser" placeholder="User"><button class="action" onclick="openNewDM()">Start Chat</button></div>`;
  html += `</div>`;
  area.innerHTML = html;
}

function openNewDM(){
  const u = document.getElementById("newDMUser").value.trim();
  if (!u) return alert("Enter username");
  openDM(u);
}

function openDM(user){
  const area = el("#contentArea");
  const dms = loadJSON("btd6_localDMs", {});
  dms[user] = dms[user] || [];
  dms[user].forEach(m => m.read = true);
  saveJSON("btd6_localDMs", dms);

  let html = `<div class="feedPost"><h3>Chat ‚Äî @${escapeHtml(user)}</h3><div id="dmMsgs" style="height:300px;overflow-y:auto;border:1px solid #333;padding:6px">`;
  dms[user].forEach(m => {
    html += `<div style="margin-bottom:6px"><b>${escapeHtml(m.from)}:</b> ${escapeHtml(m.text)} <div class="small">${escapeHtml(m.time||"")}</div></div>`;
  });
  html += `</div><div style="margin-top:8px"><input id="dmText" placeholder="Message" style="width:70%"><button class="action" onclick="sendDM('${escapeAttr(user)}')">Send</button> <button onclick="loadDMList()">‚Üê Back</button></div></div>`;
  area.innerHTML = html;
}

function sendDM(user){
  const txt = document.getElementById("dmText").value.trim();
  if (!txt) return;
  const dms = loadJSON("btd6_localDMs", {});
  dms[user] = dms[user] || [];
  dms[user].push({ from: currentUser.username || "You", to: user, text: txt, time: new Date().toLocaleTimeString(), read: false });
  saveJSON("btd6_localDMs", dms);
  openDM(user);
}

/* ================= PROFILE ================= */
function loadProfile(){
  const area = el("#contentArea");
  const u = currentUser;
  area.innerHTML = `
    <div class="feedPost" style="text-align:center">
      <h3>Your Profile</h3>
      <img id="profileAvatar" src="${u.avatar || 'https://via.placeholder.com/100'}" style="width:100px;height:100px;border-radius:50%;object-fit:cover"><br>
      <input type="file" id="avatarUpload" accept="image/*" style="margin-top:8px">
      <p><b>Username</b><br><input id="profileName" value="${escapeAttr(u.username||'You')}" style="width:60%"></p>
      <p><b>Password</b><br><input type="password" id="profilePass" value="${escapeAttr(u.password||'')}" style="width:60%"></p>
      <p><b>Bio</b><br><textarea id="profileBio" style="width:80%;height:80px">${escapeHtml(u.bio||'')}</textarea></p>
      <div style="margin-top:8px"><button class="action" onclick="saveProfile()">Save</button></div>
    </div>
  `;
  el("#avatarUpload").onchange = async e => {
    const f = e.target.files[0]; if (!f) return;
    const d = await fileToDataURL(f);
    el("#profileAvatar").src = d;
    currentUser.avatar = d;
  };
}

function saveProfile(){
  currentUser.username = el("#profileName").value.trim() || "You";
  currentUser.password = el("#profilePass").value;
  currentUser.bio = el("#profileBio").value.trim();
  saveJSON("btd6_profile", currentUser);
  alert("Profile saved.");
}

/* Open any user's profile (mini timeline) */
function openProfile(username){
  const area = el("#contentArea");
  const posts = allFeedPosts.filter(p => p.author === username);
  let html = `<div class="feedPost" style="text-align:center"><h3>@${escapeHtml(username)}</h3><p class="small">${escapeHtml(currentUser.bio || "No bio")}</p><button onclick="switchTab('feed')">‚Üê Back</button></div>`;
  posts.forEach(p => html += makePostElement(p).outerHTML);
  area.innerHTML = html;
}

/* ================= NAVIGATION ================= */
function switchTab(tab){
  if (tab === "feed") loadFeed();
  else if (tab === "threads") loadThreads();
  else if (tab === "messages") loadDMList();
  else if (tab === "profile") loadProfile();
}

/* ================= Helpers ================= */
function escapeHtml(s){ if (s === undefined || s === null) return ""; return String(s).replace(/[&<>"']/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }
function escapeAttr(s){ return String(s).replace(/"/g,'&quot;'); }

/* ================= INIT ================= */
loadConfig().then(() => {
  loadFeed(); // default to feed
});

/* expose for onclick handlers used in HTML elements (some older browsers) */
window.openProfile = openProfile;
window.replyThread = replyThread;
window.refreshThreads = refreshThreads;
window.refreshFeed = refreshFeed;

</script>
</body>
</html>
