<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>üêµ BTD6 Social</title>
<style>
  :root { --bg:#121212; --card:#1a1a1a; --accent:#f6b93b; --muted:#999; }
  body{font-family:"Segoe UI",Arial,sans-serif;background:var(--bg);color:#fff;margin:0}
  header{display:flex;align-items:center;justify-content:space-between;background:#2d2d2d;padding:10px 18px;color:var(--accent);font-weight:700}
  header .brand{font-size:1.2em}
  header .userPanel{font-size:0.95em}
  #navTabs{display:flex;justify-content:center;gap:12px;background:#1e1e1e;padding:10px 0}
  #navTabs button{background:none;border:none;color:var(--accent);font-weight:700;cursor:pointer;padding:6px 12px;border-radius:6px}
  #navTabs button.active{background:#2a2e50;color:#fff}
  #contentArea{max-width:900px;margin:18px auto;padding:14px;border-radius:10px;background:var(--card);box-shadow:0 8px 30px rgba(0,0,0,0.5)}
  .feedPost{background:#161618;border-radius:8px;padding:12px;margin-bottom:14px}
  .feedPost img{max-width:100%;border-radius:8px;margin-top:8px}
  .small{color:var(--muted);font-size:0.9em}
  button.action{background:var(--accent);border:none;padding:6px 10px;border-radius:6px;cursor:pointer;margin-right:6px;color:#000;font-weight:700}
  button.danger{background:#e74c3c;color:#fff}
  textarea,input[type=text],input[type=password]{width:100%;padding:8px;border-radius:6px;border:none;background:#0f1116;color:#fff;box-sizing:border-box}
  ul.simple{list-style:none;padding:0;margin:0}
  .smallBtn{background:#2b2b2b;border:1px solid #333;padding:6px 8px;border-radius:6px;color:#fff;cursor:pointer}
  /* Auth overlay */
  #authOverlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);display:flex;align-items:center;justify-content:center;z-index:999}
  .authCard{width:360px;background:#141416;padding:18px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.7)}
  .authCard h3{margin:0 0 10px 0;color:var(--accent)}
  .authRow{margin-bottom:8px}
  .linkish{color:#4da3ff;cursor:pointer;text-decoration:underline;font-size:0.95em}
  /* responsive */
  @media (max-width:880px){
    #contentArea{margin:12px}
    .authCard{width:92%}
  }
</style>
</head>
<body>

<header>
  <div class="brand">üêµ BTD6 Social</div>
  <div class="userPanel">
    <span id="who">Not signed in</span>
    <button id="logoutBtn" class="smallBtn" style="display:none;margin-left:10px">Logout</button>
  </div>
</header>

<div id="navTabs" aria-hidden="false">
  <button data-tab="feed" class="active">Feed</button>
  <button data-tab="threads">Threads</button>
  <button data-tab="messages">Messages</button>
  <button data-tab="profile">Profile</button>
</div>

<div id="contentArea">Loading...</div>

<!-- Auth overlay -->
<div id="authOverlay" style="display:none">
  <div class="authCard">
    <div id="authForms">
      <!-- Login form -->
      <div id="loginForm">
        <h3>Welcome ‚Äî Sign In</h3>
        <div class="authRow"><input id="loginUser" placeholder="Username"></div>
        <div class="authRow"><input id="loginPass" type="password" placeholder="Password"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button class="action" onclick="doLogin()">Login</button>
          <button class="smallBtn" onclick="showRegister()">Register</button>
        </div>
        <p class="small" style="margin-top:10px">Don't have an account? <span class="linkish" onclick="showRegister()">Create one</span></p>
      </div>

      <!-- Register form -->
      <div id="registerForm" style="display:none">
        <h3>Create account</h3>
        <div class="authRow"><input id="regUser" placeholder="Choose username"></div>
        <div class="authRow"><input id="regPass" type="password" placeholder="Choose password"></div>
        <div class="authRow"><input id="regBio" placeholder="Short bio (optional)"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button class="action" onclick="doRegister()">Register</button>
          <button class="smallBtn" onclick="showLogin()">Back</button>
        </div>
        <p class="small" style="margin-top:10px">By registering you store this account locally in your browser.</p>
      </div>
    </div>
  </div>
</div>

<script>
/* ================== Keys & storage ================== */
const KEY = "5duM4W8HZiQBSU4v";
const ROOM = "btd6-social";
let SERVER_URL = "";
const PROFILE_KEY = "btd6_profile";
const USERS_KEY = "btd6_users";
const LOCAL_POSTS = "btd6_localPosts";
const LOCAL_DMS = "btd6_localDMs";
const THREADS_REFRESH_MS = 30000;
const FEED_REFRESH_MS = 30000;

/* ================== App state ================== */
let currentUser = JSON.parse(localStorage.getItem(PROFILE_KEY) || "null") || null;
if (currentUser && !currentUser.username) currentUser.username = "You";
let allFeedPosts = [];
let feedTimer = null;
let threadTimer = null;

/* ================== DOM helpers ================== */
const el = s => document.querySelector(s);
const qAll = s => Array.from(document.querySelectorAll(s));
const saveJSON = (k,v) => localStorage.setItem(k, JSON.stringify(v));
const loadJSON = (k, fallback) => { try { return JSON.parse(localStorage.getItem(k)||"null") || fallback } catch(e) { return fallback } };

/* ================== Config loader (tunnel.txt) ================== */
async function loadConfig(){
  try {
    const r = await fetch("tunnel.txt");
    if (r.ok) {
      SERVER_URL = (await r.text()).trim();
      if (SERVER_URL.endsWith("/")) SERVER_URL = SERVER_URL.slice(0,-1);
      console.log("SERVER_URL =", SERVER_URL);
    }
  } catch(e){
    console.warn("tunnel.txt not found or failed to load.");
  }
}

/* ================== Authentication UI ================== */
function showAuthOverlay(){ el("#authOverlay").style.display = "flex"; showLogin(); }
function hideAuthOverlay(){ el("#authOverlay").style.display = "none"; }
function showLogin(){ el("#loginForm").style.display = "block"; el("#registerForm").style.display = "none"; }
function showRegister(){ el("#loginForm").style.display = "none"; el("#registerForm").style.display = "block"; }

function setSignedInUI(){
  currentUser = JSON.parse(localStorage.getItem(PROFILE_KEY) || "null") || currentUser;
  if (currentUser && currentUser.username){
    el("#who").textContent = "Signed in: @" + currentUser.username;
    el("#logoutBtn").style.display = "inline-block";
  } else {
    el("#who").textContent = "Not signed in";
    el("#logoutBtn").style.display = "none";
  }
}

/* === Login/Register logic (local-only, safe) === */
function doRegister(){
  const username = (el("#regUser").value || "").trim();
  const pass = (el("#regPass").value || "").trim();
  const bio = (el("#regBio").value || "").trim();
  if (!username || !pass) return alert("Enter username and password.");
  const users = loadJSON(USERS_KEY, {});
  if (users[username]) return alert("Username taken. Choose another.");
  users[username] = { password: pass, bio: bio || "", avatar: "" };
  saveJSON(USERS_KEY, users);
  currentUser = { username, password: pass, bio: bio || "", avatar: "" };
  localStorage.setItem(PROFILE_KEY, JSON.stringify(currentUser));
  setSignedInUI();
  hideAuthOverlay();
  switchTab("feed");
  alert("Registered & signed in as @" + username);
}

function doLogin(){
  const username = (el("#loginUser").value || "").trim();
  const pass = (el("#loginPass").value || "").trim();
  if (!username || !pass) return alert("Enter username and password.");
  const users = loadJSON(USERS_KEY, {});
  const u = users[username];
  if (!u || u.password !== pass) return alert("Invalid username or password.");
  currentUser = { username, password: pass, bio: u.bio || "", avatar: u.avatar || "" };
  localStorage.setItem(PROFILE_KEY, JSON.stringify(currentUser));
  setSignedInUI();
  hideAuthOverlay();
  switchTab("feed");
  alert("Signed in as @" + username);
}

function doLogout(){
  if (!confirm("Log out?")) return;
  currentUser = null;
  localStorage.removeItem(PROFILE_KEY);
  setSignedInUI();
  showAuthOverlay();
}

/* ================== Initial auth check & UI wiring ================== */
el("#logoutBtn").addEventListener("click", doLogout);
setSignedInUI();
function ensureSignedIn(){
  currentUser = JSON.parse(localStorage.getItem(PROFILE_KEY) || "null") || currentUser;
  if (!currentUser || !currentUser.username){
    showAuthOverlay(); setSignedInUI(); return false;
  }
  hideAuthOverlay(); setSignedInUI(); return true;
}

/* ================== Tab navigation wiring ================== */
qAll("#navTabs button").forEach(btn => {
  btn.addEventListener("click", ()=> {
    qAll("#navTabs button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    const tab = btn.getAttribute("data-tab") || btn.textContent.toLowerCase();
    switchTab(tab);
  });
});

/* ================== FEED logic ================== */
async function loadFeed(){
  if (!ensureSignedIn()) return;
  clearInterval(feedTimer);
  await refreshFeed();
  feedTimer = setInterval(refreshFeed, FEED_REFRESH_MS);
}

async function refreshFeed(){
  const area = el("#contentArea");
  area.innerHTML = `<div class="feedPost"><div class="small">Loading feed...</div></div>`;
  let serverPosts = [];
  try {
    const res = await fetch("btd6-social.json");
    if (res.ok) { const j = await res.json(); serverPosts = j.posts || []; }
  } catch(e) { console.warn("Could not load btd6-social.json", e); }
  const local = loadJSON(LOCAL_POSTS, []);
  allFeedPosts = [...local, ...serverPosts];
  renderFeed();
}

function renderFeed(){
  const area = el("#contentArea");
  area.innerHTML = "";
  const box = document.createElement("div"); box.className="feedPost";
  box.innerHTML = `
    <h3>Create a Post</h3>
    <textarea id="newPostText" placeholder="What's on your mind?" style="height:70px"></textarea>
    <input id="newPostLink" placeholder="Optional link" style="margin-top:8px">
    <input type="file" id="newPostImage" accept="image/*" style="margin-top:8px">
    <div style="margin-top:8px"><button class="action" onclick="handleCreatePost()">Post</button></div>
  `;
  area.appendChild(box);

  allFeedPosts.sort((a,b)=>b.id - a.id);
  for (const p of allFeedPosts){
    const postEl = document.createElement("div"); postEl.className = "feedPost";
    // Title is clickable and opens the standalone post view
    let html = `<h4><a href="#" onclick="openPost(${p.id});return false">@${escapeHtml(p.author)}</a></h4>`;
    if (p.text) html += `<p>${escapeHtml(p.text)}</p>`;
    html += `<div class="small">${escapeHtml(p.time || "")}</div>`;
    postEl.innerHTML = html;

    if (p.image){
      const img = document.createElement("img"); img.src = p.image; img.alt = "";
      img.onerror = ()=>{ /* ignore broken image */ };
      postEl.appendChild(img);
    }
    if (p.link){
      const linkWrap = document.createElement("div");
      linkWrap.innerHTML = `<p><a href="${escapeAttr(p.link)}" target="_blank">${escapeHtml(p.link)}</a></p>`;
      postEl.appendChild(linkWrap);
    }

    // action buttons: use event listeners so clicks don't cause navigation
    const actions = document.createElement("div"); actions.style.marginTop = "8px";
    const likeBtn = document.createElement("button"); likeBtn.className="action"; likeBtn.textContent = `üëç ${ (p.likes||[]).length }`;
    likeBtn.addEventListener("click", (e)=>{ e.stopPropagation(); toggleLike(p.id,'like'); });
    const disBtn = document.createElement("button"); disBtn.className="action"; disBtn.textContent = `üëé ${ (p.dislikes||[]).length }`;
    disBtn.addEventListener("click", (e)=>{ e.stopPropagation(); toggleLike(p.id,'dislike'); });
    const comBtn = document.createElement("button"); comBtn.className="action"; comBtn.textContent = `üí¨ ${ (p.comments||[]).length }`;
    comBtn.addEventListener("click", (e)=>{ e.stopPropagation(); promptComment(p.id); });
    const shareBtn = document.createElement("button"); shareBtn.className="action"; shareBtn.textContent = "üîó Share";
    shareBtn.addEventListener("click", (e)=>{ e.stopPropagation(); sharePost(p.id); });
    actions.appendChild(likeBtn); actions.appendChild(disBtn); actions.appendChild(comBtn); actions.appendChild(shareBtn);

    if (p.author === (currentUser && currentUser.username ? currentUser.username : "You")){
      const del = document.createElement("button"); del.className="danger"; del.textContent="üóë Delete";
      del.addEventListener("click", (e)=>{ e.stopPropagation(); deletePost(p.id); });
      actions.appendChild(del);
    }
    postEl.appendChild(actions);

    // comments inline
    const cmWrap = document.createElement("div");
    cmWrap.style.marginTop = "6px"; cmWrap.style.borderTop = "1px solid #333"; cmWrap.style.paddingTop = "6px";
    if (p.comments && p.comments.length){
      p.comments.forEach(c=>{
        const cd = document.createElement("div"); cd.className="small"; cd.style.marginLeft="8px";
        cd.innerHTML = `<b>${escapeHtml(c.author)}</b>: ${escapeHtml(c.text)} <span class="small">(${escapeHtml(c.time||"")})</span>`;
        cmWrap.appendChild(cd);
      });
    }
    postEl.appendChild(cmWrap);

    // Make the whole post clickable to open the same post (but title already does that).
    postEl.addEventListener("dblclick", ()=> openPost(p.id)); // double-click as alternative

    area.appendChild(postEl);
  }
}

/* Open a standalone post view and update URL ?post=<id> */
function openPost(id){
  const p = allFeedPosts.find(x=>x.id === id);
  if (!p) return alert("Post not found");
  const area = el("#contentArea");
  history.replaceState({}, "", window.location.pathname + "?post=" + id);
  area.innerHTML = "";
  const postEl = document.createElement("div"); postEl.className = "feedPost";
  let html = `<h3>@${escapeHtml(p.author)}</h3>`;
  if (p.text) html += `<p>${escapeHtml(p.text)}</p>`;
  html += `<div class="small">${escapeHtml(p.time || "")}</div>`;
  postEl.innerHTML = html;
  if (p.image){
    const img = document.createElement("img"); img.src = p.image; img.alt = "";
    postEl.appendChild(img);
  }
  if (p.link){
    const linkWrap = document.createElement("div");
    linkWrap.innerHTML = `<p><a href="${escapeAttr(p.link)}" target="_blank">${escapeHtml(p.link)}</a></p>`;
    postEl.appendChild(linkWrap);
  }
  // action buttons
  const actions = document.createElement("div"); actions.style.marginTop = "8px";
  const likeBtn = document.createElement("button"); likeBtn.className="action"; likeBtn.textContent = `üëç ${ (p.likes||[]).length }`;
  likeBtn.addEventListener("click", ()=> toggleLike(p.id,'like'));
  const disBtn = document.createElement("button"); disBtn.className="action"; disBtn.textContent = `üëé ${ (p.dislikes||[]).length }`;
  disBtn.addEventListener("click", ()=> toggleLike(p.id,'dislike'));
  const comBtn = document.createElement("button"); comBtn.className="action"; comBtn.textContent = `üí¨ ${ (p.comments||[]).length }`;
  comBtn.addEventListener("click", ()=> promptComment(p.id));
  const shareBtn = document.createElement("button"); shareBtn.className="action"; shareBtn.textContent = "üîó Share";
  shareBtn.addEventListener("click", ()=> sharePost(p.id));
  const backBtn = document.createElement("button"); backBtn.className="smallBtn"; backBtn.textContent = "‚Üê Back";
  backBtn.addEventListener("click", ()=> { history.replaceState({}, "", window.location.pathname); renderFeed(); });

  actions.appendChild(backBtn); actions.appendChild(likeBtn); actions.appendChild(disBtn); actions.appendChild(comBtn); actions.appendChild(shareBtn);

  if (p.author === (currentUser && currentUser.username ? currentUser.username : "You")){
    const del = document.createElement("button"); del.className="danger"; del.textContent="üóë Delete";
    del.addEventListener("click", ()=> { if(confirm("Delete this post?")){ deletePost(p.id); history.replaceState({}, "", window.location.pathname); refreshFeed(); }});
    actions.appendChild(del);
  }

  postEl.appendChild(actions);

  // comments area (editable)
  const commentsWrap = document.createElement("div");
  commentsWrap.style.marginTop = "10px";
  commentsWrap.innerHTML = `<h4>Comments</h4>`;
  if (p.comments && p.comments.length){
    p.comments.forEach(c=>{
      const cd = document.createElement("div"); cd.className="small"; cd.style.marginBottom="6px";
      cd.innerHTML = `<b>${escapeHtml(c.author)}</b>: ${escapeHtml(c.text)} <span class="small">(${escapeHtml(c.time||"")})</span>`;
      commentsWrap.appendChild(cd);
    });
  } else {
    const note = document.createElement("div"); note.className="small"; note.textContent = "No comments yet.";
    commentsWrap.appendChild(note);
  }
  // add comment input
  const commentBox = document.createElement("div"); commentBox.style.marginTop="8px";
  commentBox.innerHTML = `<input id="singlePostComment" placeholder="Write a comment..." style="width:70%"><button class="action" id="singlePostCommentBtn">Post</button>`;
  commentBox.querySelector("#singlePostCommentBtn").addEventListener("click", ()=> {
    const txt = commentBox.querySelector("#singlePostComment").value.trim();
    if (!txt) return alert("Write a comment");
    p.comments = p.comments || [];
    p.comments.push({ author: currentUser.username || "You", text: txt, time: new Date().toLocaleTimeString() });
    // update local storage if local
    const local = loadJSON(LOCAL_POSTS, []);
    const idx = local.findIndex(x=>x.id===p.id);
    if (idx >= 0){ local[idx] = p; saveJSON(LOCAL_POSTS, local); }
    openPost(p.id); // re-open to refresh view
  });
  postEl.appendChild(commentsWrap);
  postEl.appendChild(commentBox);

  area.appendChild(postEl);
}

/* ================== Create/post helpers used in feed ================== */
async function handleCreatePost(){
  if (!ensureSignedIn()) return;
  const text = el("#newPostText").value.trim();
  const link = el("#newPostLink").value.trim();
  const file = el("#newPostImage").files[0];
  if (!text && !link && !file) return alert("Write or attach something first.");
  const post = { id: Date.now(), author: currentUser.username || "You", text, link, image: "", time: new Date().toLocaleString(), likes: [], dislikes: [], comments: [] };
  if (file) post.image = await fileToDataURL(file);
  const local = loadJSON(LOCAL_POSTS, []);
  local.push(post); saveJSON(LOCAL_POSTS, local);
  await refreshFeed();
  el("#newPostText").value=""; el("#newPostLink").value=""; el("#newPostImage").value="";
}
function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
function toggleLike(id,type){ const me = currentUser && currentUser.username ? currentUser.username : "You"; const p = allFeedPosts.find(x=>x.id===id); if(!p) return; p.likes = p.likes || []; p.dislikes = p.dislikes || []; if(type==="like"){ if(p.likes.includes(me)) p.likes = p.likes.filter(u=>u!==me); else { p.likes.push(me); p.dislikes = p.dislikes.filter(u=>u!==me);} } else { if(p.dislikes.includes(me)) p.dislikes = p.dislikes.filter(u=>u!==me); else { p.dislikes.push(me); p.likes = p.likes.filter(u=>u!==me);} } const local = loadJSON(LOCAL_POSTS, []); const idx = local.findIndex(x=>x.id===p.id); if (idx >= 0){ local[idx] = p; saveJSON(LOCAL_POSTS, local); } renderFeed(); }
function promptComment(id){ const t = prompt("Enter comment:"); if(!t) return; const p = allFeedPosts.find(x=>x.id===id); if(!p) return; p.comments = p.comments || []; p.comments.push({ author: currentUser.username || "You", text: t, time: new Date().toLocaleTimeString() }); const local = loadJSON(LOCAL_POSTS, []); const idx = local.findIndex(x=>x.id===p.id); if (idx >= 0){ local[idx] = p; saveJSON(LOCAL_POSTS, local); } renderFeed(); }
function deletePost(id){ if (!confirm("Delete this post?")) return; let local = loadJSON(LOCAL_POSTS, []); local = local.filter(p=>p.id !== id); saveJSON(LOCAL_POSTS, local); allFeedPosts = allFeedPosts.filter(p=>p.id !== id); renderFeed(); }
function sharePost(id){ const url = window.location.origin + window.location.pathname + "?post=" + id; navigator.clipboard.writeText(url).then(()=> alert("Link copied!"), ()=> alert("Could not copy link.")); }

/* ================= THREADS (server-synced via /room/<ROOM>) ================= */
async function loadThreads(){
  if (!ensureSignedIn()) return;
  clearInterval(threadTimer);
  await refreshThreads();
  threadTimer = setInterval(refreshThreads, THREADS_REFRESH_MS);
}
async function refreshThreads(){
  const area = el("#contentArea"); area.innerHTML = `<div class="feedPost"><div class="small">Loading threads...</div></div>`;
  if (!SERVER_URL) { area.innerHTML = `<div class="feedPost"><div class="small">Server not configured (tunnel.txt missing)</div></div>`; return; }
  try {
    const res = await fetch(`${SERVER_URL}/room/${ROOM}?key=${KEY}`);
    const json = await res.json();
    if (!json.ok) throw new Error("server returned not ok");
    const threads = json.data?.threads || [];
    renderThreads(threads);
  } catch(e){
    console.warn("Failed to load threads:", e);
    area.innerHTML = `<div class="feedPost"><div class="small">‚ö†Ô∏è Could not reach server for threads.</div></div>`;
  }
}
function renderThreads(threads){
  const area = el("#contentArea");
  area.innerHTML = `
    <div class="feedPost">
      <h3>Create a Thread</h3>
      <input id="threadTitle" placeholder="Thread title" style="margin-top:8px">
      <textarea id="threadBody" placeholder="Thread content" style="height:70px;margin-top:8px"></textarea>
      <div style="margin-top:8px"><button class="action" onclick="createThread()">Create</button></div>
    </div>
  `;
  threads.sort((a,b)=>b.id - a.id);
  threads.forEach(t=>{
    const d = document.createElement("div"); d.className = "feedPost";
    let inner = `<h4>${escapeHtml(t.title)}</h4><div class="small">by ${escapeHtml(t.author)}${t.time ? " ‚Ä¢ " + escapeHtml(t.time) : ""}</div>`;
    if (t.text) inner += `<p>${escapeHtml(t.text)}</p>`;
    inner += `<div style="margin-top:8px"><button class="action" onclick="replyThread(${t.id})">üí¨ ${ (t.replies||[]).length }</button></div>`;
    if (t.replies && t.replies.length){
      inner += `<div style="margin-top:8px;border-top:1px solid #333;padding-top:6px">`;
      t.replies.forEach(r=>{ inner += `<div style="margin-left:8px" class="small"><b>${escapeHtml(r.author)}</b>: ${escapeHtml(r.text)}</div>`; });
      inner += `</div>`;
    }
    d.innerHTML = inner;
    area.appendChild(d);
  });
}
async function createThread(){
  const title = el("#threadTitle").value.trim();
  const text = el("#threadBody").value.trim();
  if (!title || !text) return alert("Enter title and text");
  if (!SERVER_URL) return alert("Server not configured (tunnel.txt missing).");
  try {
    const res = await fetch(`${SERVER_URL}/room/${ROOM}?key=${KEY}`);
    const json = await res.json();
    const data = json.data || {};
    data.threads ||= [];
    data.threads.unshift({ id: Date.now(), author: currentUser.username || "You", title, text, replies: [], time: new Date().toLocaleString() });
    await fetch(`${SERVER_URL}/room/${ROOM}?key=${KEY}`, { method: "POST", headers: { "Content-Type":"application/json" }, body: JSON.stringify(data) });
    await refreshThreads();
  } catch(e){ alert("Could not create thread (server error)."); console.error(e); }
}
async function replyThread(id){
  const txt = prompt("Reply:"); if (!txt) return;
  if (!SERVER_URL) return alert("Server not configured (tunnel.txt missing).");
  try {
    const res = await fetch(`${SERVER_URL}/room/${ROOM}?key=${KEY}`);
    const json = await res.json();
    const data = json.data || {};
    data.threads ||= [];
    const thread = data.threads.find(t => t.id === id);
    if (!thread) return alert("Thread not found on server.");
    thread.replies ||= [];
    thread.replies.push({ author: currentUser.username || "You", text: txt, time: new Date().toLocaleTimeString() });
    await fetch(`${SERVER_URL}/room/${ROOM}?key=${KEY}`, { method: "POST", headers: { "Content-Type":"application/json" }, body: JSON.stringify(data) });
    await refreshThreads();
  } catch(e){ alert("Could not reply (server error)."); console.error(e); }
}

/* ================== DMs (local only) ================== */
function loadDMList(){
  if (!ensureSignedIn()) return;
  const dms = loadJSON(LOCAL_DMS, {});
  const area = el("#contentArea");
  let html = `<div class="feedPost"><h3>Messages</h3>`;
  const users = Object.keys(dms).sort();
  if (users.length === 0) html += `<div class="small">No conversations yet</div>`;
  for (const u of users){
    const unread = dms[u].some(m => !m.read) ? " üî¥" : "";
    html += `<div style="margin-bottom:6px"><a href="#" onclick="openDM('${escapeAttr(u)}');return false">@${escapeHtml(u)}</a>${unread}</div>`;
  }
  html += `<div style="margin-top:8px"><input id="newDMUser" placeholder="User"><button class="action" onclick="openNewDM()">Start Chat</button></div>`;
  html += `</div>`;
  area.innerHTML = html;
}
function openNewDM(){ const u = el("#newDMUser").value.trim(); if (!u) return alert("Enter username"); openDM(u); }
function openDM(user){
  if (!ensureSignedIn()) return;
  const dms = loadJSON(LOCAL_DMS, {});
  dms[user] = dms[user] || [];
  dms[user].forEach(m=>m.read = true);
  saveJSON(LOCAL_DMS, dms);
  let html = `<div class="feedPost"><h3>Chat ‚Äî @${escapeHtml(user)}</h3><div id="dmMsgs" style="height:300px;overflow-y:auto;border:1px solid #333;padding:6px">`;
  dms[user].forEach(m => html += `<div style="margin-bottom:6px"><b>${escapeHtml(m.from)}</b>: ${escapeHtml(m.text)} <div class="small">${escapeHtml(m.time||"")}</div></div>`);
  html += `</div><div style="margin-top:8px"><input id="dmText" placeholder="Message" style="width:70%"><button class="action" onclick="sendDM('${escapeAttr(user)}')">Send</button> <button onclick="loadDMList()">‚Üê Back</button></div></div>`;
  el("#contentArea").innerHTML = html;
}
function sendDM(user){
  const txt = el("#dmText").value.trim(); if (!txt) return;
  const dms = loadJSON(LOCAL_DMS, {});
  dms[user] = dms[user] || [];
  dms[user].push({ from: currentUser.username || "You", to: user, text: txt, time: new Date().toLocaleTimeString(), read: false });
  saveJSON(LOCAL_DMS, dms);
  openDM(user);
}

/* ================== PROFILE ================== */
function loadProfile(){
  if (!ensureSignedIn()) return;
  const u = currentUser;
  el("#contentArea").innerHTML = `
    <div class="feedPost" style="text-align:center">
      <h3>Your Profile</h3>
      <img id="profileAvatar" src="${escapeAttr(u.avatar || 'https://via.placeholder.com/100')}" style="width:100px;height:100px;border-radius:50%;object-fit:cover"><br>
      <input type="file" id="avatarUpload" accept="image/*" style="margin-top:8px">
      <p><b>Username</b><br><input id="profileName" value="${escapeAttr(u.username||'')}" style="width:60%"></p>
      <p><b>Password</b><br><input id="profilePass" type="password" value="${escapeAttr(u.password||'')}" style="width:60%"></p>
      <p><b>Bio</b><br><textarea id="profileBio" style="width:80%;height:80px">${escapeHtml(u.bio||'')}</textarea></p>
      <div style="margin-top:8px"><button class="action" onclick="saveProfile()">Save</button></div>
    </div>
  `;
  el("#avatarUpload").onchange = async e => {
    const f = e.target.files[0]; if (!f) return;
    const d = await fileToDataURL(f);
    el("#profileAvatar").src = d;
    currentUser.avatar = d;
  };
}
function saveProfile(){
  currentUser.username = el("#profileName").value.trim() || "You";
  currentUser.password = el("#profilePass").value;
  currentUser.bio = el("#profileBio").value.trim();
  saveJSON(PROFILE_KEY, currentUser);
  const users = loadJSON(USERS_KEY, {});
  users[currentUser.username] = users[currentUser.username] || {};
  users[currentUser.username].password = currentUser.password;
  users[currentUser.username].bio = currentUser.bio;
  users[currentUser.username].avatar = currentUser.avatar || "";
  saveJSON(USERS_KEY, users);
  alert("Profile saved.");
  setSignedInUI();
}
function openProfile(username){
  const posts = allFeedPosts.filter(p => p.author === username);
  let html = `<div class="feedPost" style="text-align:center"><h3>@${escapeHtml(username)}</h3><p class="small">User profile</p><button onclick="switchTab('feed')">‚Üê Back</button></div>`;
  posts.forEach(p => html += makeMiniPostHTML(p));
  el("#contentArea").innerHTML = html;
}
function makeMiniPostHTML(p){
  const div = document.createElement("div"); div.className="feedPost";
  let inner = `<div>${escapeHtml(p.text||"")}</div><div class="small">${escapeHtml(p.time||"")}</div>`;
  div.innerHTML = inner;
  return div.outerHTML;
}

/* ================== Nav & helpers ================== */
function switchTab(tab){
  if (!ensureSignedIn()) return;
  qAll("#navTabs button").forEach(b => b.classList.remove("active"));
  const btn = qAll("#navTabs button").find(b => (b.getAttribute("data-tab")||b.textContent.toLowerCase()) === tab);
  if (btn) btn.classList.add("active");
  if (tab === "feed") loadFeed();
  else if (tab === "threads") loadThreads();
  else if (tab === "messages") loadDMList();
  else if (tab === "profile") loadProfile();
}
function escapeHtml(s){ if (s===undefined || s===null) return ""; return String(s).replace(/[&<>"']/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }
function escapeAttr(s){ return String(s).replace(/"/g,'&quot;'); }

/* ================== Init ================== */
(async function init(){
  await loadConfig();
  // initial auth
  currentUser = JSON.parse(localStorage.getItem(PROFILE_KEY) || "null") || currentUser;
  setSignedInUI();
  if (!currentUser || !currentUser.username) {
    showAuthOverlay();
  } else {
    // ensure user saved in users map
    const users = loadJSON(USERS_KEY, {});
    users[currentUser.username] = users[currentUser.username] || {};
    users[currentUser.username].password = currentUser.password || users[currentUser.username].password || "";
    users[currentUser.username].bio = currentUser.bio || users[currentUser.username].bio || "";
    users[currentUser.username].avatar = currentUser.avatar || users[currentUser.username].avatar || "";
    saveJSON(USERS_KEY, users);
    // if ?post=ID present, open that post; else open feed
    const params = new URLSearchParams(window.location.search);
    if (params.has("post")) {
      // load feed data first, then open the post
      await refreshFeed();
      const pid = Number(params.get("post"));
      if (!isNaN(pid)) openPost(pid);
      else loadFeed();
    } else {
      switchTab("feed");
    }
  }
})();

/* expose some functions for inline handlers & console */
window.openProfile = openProfile;
window.replyThread = replyThread;
window.refreshThreads = refreshThreads;
window.refreshFeed = refreshFeed;
window.openPost = openPost;

</script>
</body>
</html>
